#!/usr/bin/env python3
"""
List CLI tools installed on the system with a PyQt-based search UI.
"""

from __future__ import annotations

import subprocess
import sys
from pathlib import Path
from typing import Iterable, List, Sequence, Tuple

try:
	from PyQt6 import QtCore, QtGui, QtWidgets
except ImportError as exc:  # pragma: no cover - depends on user environment
	print("This application requires python3-pyqt6 to be installed.", file=sys.stderr)
	print(exc, file=sys.stderr)
	sys.exit(1)

LIST_LOCATIONS: Sequence[Path] = (
	Path("/usr/share/list-cli-tools/cli-tools.list"),
	Path(__file__).resolve().parent / "cli-tools.list",
)

PKG_FIELDS = ("package", "version", "summary")


def find_list_file() -> Path:
	for candidate in LIST_LOCATIONS:
		if candidate.exists():
			return candidate
	raise FileNotFoundError(
		"Could not locate cli-tools.list. Install the package or keep the list next to this script."
	)


def read_packages(list_file: Path) -> List[str]:
	with list_file.open(encoding="utf-8") as handle:
		names = {line.strip() for line in handle if line.strip() and not line.lstrip().startswith("#")}
	return sorted(names, key=str.lower)


def query_packages(packages: Sequence[str]) -> List[Tuple[str, str, str]]:
	if not packages:
		return []

	format_str = "${db:Status-Abbrev}\t${binary:Package}\t${Version}\t${binary:Summary}\n"
	cmd = ["dpkg-query", "-W", f"--showformat={format_str}", *packages]
	result = subprocess.run(
		cmd,
		text=True,
		stdout=subprocess.PIPE,
		stderr=subprocess.DEVNULL,
		check=False,
	)

	data: List[Tuple[str, str, str]] = []

	for line in result.stdout.splitlines():
		if not line.strip():
			continue
		parts = line.split("\t")
		if len(parts) < 4:
			continue
		status, name, version, summary = parts[:4]
		if not status.startswith("ii"):
			continue
		name = name.strip() or "unknown"
		version = version.strip() or "unknown"
		summary = summary.strip() or "No summary available."
		data.append((name, version, summary))

	return data


def build_dataset(packages: Iterable[str]) -> List[Tuple[str, str, str]]:
	return query_packages(list(packages))


class PackageFilter(QtCore.QSortFilterProxyModel):
	def __init__(self, parent: QtCore.QObject | None = None) -> None:
		super().__init__(parent)
		self.query = ""
		self.setSortCaseSensitivity(QtCore.Qt.CaseSensitivity.CaseInsensitive)

	def set_query(self, query: str) -> None:
		self.query = query.strip().lower()
		self.invalidateFilter()

	def filterAcceptsRow(self, source_row: int, source_parent: QtCore.QModelIndex) -> bool:  # noqa: N802
		if not self.query:
			return True
		model = self.sourceModel()
		if model is None:
			return False
		for column in range(model.columnCount()):
			index = model.index(source_row, column, source_parent)
			value = model.data(index, QtCore.Qt.ItemDataRole.DisplayRole)
			if isinstance(value, str) and self.query in value.lower():
				return True
		return False

	def lessThan(
		self, left: QtCore.QModelIndex, right: QtCore.QModelIndex
	) -> bool:  # noqa: N802
		model = self.sourceModel()
		if model is None:
			return False
		left_data = model.data(left, QtCore.Qt.ItemDataRole.DisplayRole)
		right_data = model.data(right, QtCore.Qt.ItemDataRole.DisplayRole)
		if isinstance(left_data, str) and isinstance(right_data, str):
			return left_data.lower() < right_data.lower()
		return super().lessThan(left, right)


class PackageWindow(QtWidgets.QMainWindow):
	def __init__(self, data: List[Tuple[str, str, str]]) -> None:
		super().__init__()
		self.setWindowTitle("List of CLI packages")
		self.resize(960, 640)

		icon = QtGui.QIcon.fromTheme("utilities-terminal")
		if not icon.isNull():
			self.setWindowIcon(icon)

		central = QtWidgets.QWidget()
		self.setCentralWidget(central)
		layout = QtWidgets.QVBoxLayout()
		layout.setContentsMargins(16, 16, 16, 16)
		layout.setSpacing(10)
		central.setLayout(layout)

		title = QtWidgets.QLabel("<b>CLI packages installed on this system</b>")
		title.setTextFormat(QtCore.Qt.TextFormat.RichText)
		title.setAlignment(
			QtCore.Qt.AlignmentFlag.AlignLeft | QtCore.Qt.AlignmentFlag.AlignVCenter
		)
		subtitle = QtWidgets.QLabel(
			"Use the search box or press Ctrl+L to focus it. Double-click a row to copy details."
		)
		subtitle.setStyleSheet("color: #555555;")
		subtitle.setAlignment(
			QtCore.Qt.AlignmentFlag.AlignLeft | QtCore.Qt.AlignmentFlag.AlignVCenter
		)
		layout.addWidget(title)
		layout.addWidget(subtitle)

		self.search_entry = QtWidgets.QLineEdit()
		self.search_entry.setPlaceholderText("Search by package name, summary, or version")
		self.search_entry.setClearButtonEnabled(True)
		layout.addWidget(self.search_entry)

		self.model = QtGui.QStandardItemModel(0, len(PKG_FIELDS))
		self.model.setHorizontalHeaderLabels(["Package", "Version", "Summary"])
		for row in data:
			items = [QtGui.QStandardItem(field) for field in row]
			bold_font = QtGui.QFont()
			bold_font.setBold(True)
			items[0].setData(bold_font, QtCore.Qt.ItemDataRole.FontRole)
			items[2].setData(
				QtCore.Qt.AlignmentFlag.AlignLeft | QtCore.Qt.AlignmentFlag.AlignTop,
				QtCore.Qt.ItemDataRole.TextAlignmentRole,
			)
			self.model.appendRow(items)

		self.proxy = PackageFilter(self)
		self.proxy.setSourceModel(self.model)

		self.table = QtWidgets.QTableView()
		self.table.setModel(self.proxy)
		self.table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectionBehavior.SelectRows)
		self.table.setSelectionMode(QtWidgets.QAbstractItemView.SelectionMode.SingleSelection)
		self.table.setAlternatingRowColors(True)
		self.table.horizontalHeader().setStretchLastSection(True)
		self.table.verticalHeader().setVisible(False)
		self.table.setWordWrap(True)
		self.table.setSortingEnabled(True)
		self.table.doubleClicked.connect(self.copy_row_to_clipboard)
		self.table.sortByColumn(0, QtCore.Qt.SortOrder.AscendingOrder)
		layout.addWidget(self.table, stretch=1)

		self.count_label = QtWidgets.QLabel()
		layout.addWidget(self.count_label)

		button_box = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.StandardButton.Close)
		button_box.rejected.connect(self.close)
		layout.addWidget(button_box)

		self.search_entry.textChanged.connect(self.on_search_changed)
		self.update_counts()

		shortcuts = []
		shortcut_focus = QtGui.QShortcut(QtGui.QKeySequence("Ctrl+L"), self)
		shortcut_focus.activated.connect(self.focus_search)
		shortcuts.append(shortcut_focus)

		shortcut_close = QtGui.QShortcut(QtGui.QKeySequence("Ctrl+W"), self)
		shortcut_close.activated.connect(self.close)
		shortcuts.append(shortcut_close)

		shortcut_clear = QtGui.QShortcut(QtGui.QKeySequence("Escape"), self.search_entry)
		shortcut_clear.activated.connect(lambda: self.search_entry.clear())
		shortcuts.append(shortcut_clear)

		self._shortcuts = shortcuts  # keep references

	def focus_search(self) -> None:
		self.search_entry.setFocus()
		self.search_entry.selectAll()

	def on_search_changed(self, text: str) -> None:
		self.proxy.set_query(text)
		self.update_counts()

	def update_counts(self) -> None:
		total = self.model.rowCount()
		visible = self.proxy.rowCount()
		self.count_label.setText(f"{visible} of {total} packages shown")

	def copy_row_to_clipboard(self, index: QtCore.QModelIndex) -> None:
		if not index.isValid():
			return
		source_index = self.proxy.mapToSource(index)
		row_values = []
		for column in range(self.model.columnCount()):
			item = self.model.item(source_index.row(), column)
			row_values.append(item.text())
		clipboard = QtWidgets.QApplication.clipboard()
		clipboard.setText(" | ".join(row_values))


def main() -> None:
	try:
		list_file = find_list_file()
	except FileNotFoundError as err:
		print(err, file=sys.stderr)
		sys.exit(1)

	packages = read_packages(list_file)
	data = build_dataset(packages)

	app = QtWidgets.QApplication(sys.argv)
	app.setApplicationName("List CLI Tools")
	window = PackageWindow(data)
	window.show()
	sys.exit(app.exec())


if __name__ == "__main__":
	main()
